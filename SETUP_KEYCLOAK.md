# FIWAREのデータアクセス管理
CityOSでは、大きく「public」「protected」という２種類のデータグループに分けてデータを管理する。
|データグループ|読み取り|書き込み|
|----|----|----|
|public|認証不要|認証が必要|
|protected|認証が必要|認証が必要|

認証が必要なアクセスでは、事前にKeycloakを使ってユーザー登録が必要になる。

# Keycloak セットアップ
Keycloakを使って、FIWAREのDBにアクセスするユーザーの権限を管理する。  
ユーザー登録時、アクセスを許可するFIWAREの「Fiware-Service」と「Fiware-ServicePath」、および、そのデータに対する「アクセスモード」を割り当てる。  

詳細は、「Keycloakの構築手順書」を参照。ここでは簡単な説明を記載する。  

## Client
「Kong」というClientを作成する。  
|項目|説明|
|----|----|
|realm|cityos|
|Client ID|Kong|
|Description|confirm orion user|

## ユーザー属性
Keycloakにカスタムのユーザー属性を２つ追加する。  
|カスタムユーザー属性|内容|
|----|----|
|allowed_fiware_scopes|そのユーザーがアクセスできる「fiware-service」と「fiware-servicepath」の組み合わせ|
|access_level|上記で指定したデータへのアクセスモード（read_only, read_write）|

allowed_fiware_scopesの例

    {"fiware-service": "bodik", "fiware-servicepath": "/public/Amedas"}
    
作成したカスタム属性をアクセストークンに含めるように設定する。  
こうすることで、アクセストークンを調べると、そのユーザーがアクセスできるデータセットとアクセスモードを知ることができる。  

## アクセストークン
ログインすると、アクセストークンとリフレッシュトークンが発行される。  
アクセストークン自体に、そのアクセストークンでアクセスできるデータセットとアクセスモードが記録されている。  

アクセストークンが流出すると、サーバー側でそのアクセストークンを無効にすることはできない。  
アクセストークンの流出対策として、アクセストークンの寿命を短くする（５分に設定）。　　

アクセストークンの寿命が切れた場合は、リフレッシュトークンで延命することができる。ただし、延命には限界（ログイン後60分に設定）がある。  
リフレッシュもできなくなった場合は、再度アクセストークンの取得を行う。 

ユーザー認証用に、ログインとリフレッシュのAPIを提供する。  
|API|機能|
|----|----|
|/auth/login|ユーザー登録時に発行されるusernameとpasswordを指定してログイン認証する。<br>アクセストークンとリフレッシュトークンが発行される。|
|/auth/refresh|リフレッシュトークンを指定してアクセストークンを延命する。|


通常、アクセストークンの取得とリフレッシュ処理、アクセストークンの再取得は、アプリケーションが自動的に行うことで、ユーザーが不便に感じることはない。


