# FIWAREのデータアクセス管理
CityOSでは、大きく「public」「protected」という２種類のデータグループに分けてデータを管理する。
|データグループ|読み取り|書き込み|
|----|----|----|
|public|認証不要|認証が必要|
|protected|認証が必要|認証が必要|

認証が必要なアクセスでは、事前にKeycloakを使ってユーザー登録が必要になる。

# Keycloak セットアップ
Keycloakを使って、FIWAREのDBにアクセスするユーザーの権限を管理する。  
ユーザー登録時、アクセスを許可するFIWAREの「Fiware-Service」と「Fiware-ServicePath」、および、そのデータに対する「アクセスモード」を割り当てる。  

詳細は、「Keycloakの構築手順書」を参照。ここでは簡単な説明を記載する。  

## Client
「Kong」というClientを作成する。  
|項目|説明|
|----|----|
|realm|cityos|
|Client ID|Kong|
|Description|confirm orion user|

## ユーザー属性
Keycloakにカスタムのユーザー属性を２つ追加する。  
|カスタムユーザー属性|内容|
|----|----|
|allowed_fiware_scopes|そのユーザーがアクセスできる「Fiware-Service」と「Fiware-ServicePath」の組み合わせ|
|access_level|上記で指定したデータへのアクセスモード（read_only, read_write）|

作成したカスタム属性をアクセストークンに含めるように設定する。  
こうすることで、アクセストークンを調べると、そのユーザーがアクセスできるデータセットとアクセスモードを知ることができる。  

## アクセストークン
アクセストークン自体に、そのアクセストークンでアクセスできるデータセットとアクセスモードが記録されている。  

アクセストークンが流出すると、サーバー側でそのアクセストークンを無効にすることはできない。  
アクセストークンの流出対策として、アクセストークンの寿命を短く設定する。　　

アクセストークンの寿命が切れた場合は、リフレッシュトークンで延命することができる。ただし、延命には限界がある。  
リフレッシュもできなくなった場合は、再度アクセストークンの取得を行う。 

通常、アクセストークンの取得とリフレッシュ処理、アクセストークンの再取得は、アプリケーションが自動的に行うことで、ユーザーが不便に感じることはない。
